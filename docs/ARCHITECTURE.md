# Architecture Guide

This guide covers the tech stack, project structure, and key architectural decisions.

## Tech Stack

### Core Framework

- **TanStack Start** - Full-stack React framework built on Vite
- **TanStack Router** - Type-safe file-based routing
- **React 19** - UI library
- **TypeScript** - Type safety

### UI and Styling

- **Chakra UI** - Component library and design system
- **Emotion** - CSS-in-JS (used by Chakra UI)
- **Framer Motion** - Animation library (used by Chakra UI)

### Data Fetching and State

- **TanStack Query** - Server state management
- **TanStack Router SSR Query** - SSR integration for queries
- **Octokit** - GitHub API client
- **Downshift** - Accessible autocomplete/combobox

### Markdown Processing

- **unified** - Markdown/HTML processing framework
- **remark-parse** - Parse markdown to AST
- **remark-gfm** - GitHub Flavored Markdown support
- **remark-emoji** - Emoji support
- **remark-github** - GitHub-specific markdown features
- **remark-rehype** - Convert markdown AST to HTML AST
- **rehype-highlight** - Syntax highlighting
- **rehype-react** - Render HTML AST as React components

### Build and Development

- **Vite** - Build tool and dev server
- **Netlify Adapter** - Deploy to Netlify with static prerendering
- **Sentry** - Error tracking and monitoring

### Testing

- **Vitest** - Unit testing framework
- **Playwright** - E2E testing framework
- **MSW (Mock Service Worker)** - API mocking
- **React Testing Library** - React component testing utilities
- **Happo** - Visual regression testing

### Utilities

- **es-toolkit** - Modern utility library
- **semver** - Semantic version comparison
- **js-cookie** - Cookie management

## Project Structure

```
octochangelog/
├── src/
│   ├── routes/                    # TanStack Router file-based routes
│   │   ├── __root.tsx            # Root layout component
│   │   ├── index.tsx             # Home page (/)
│   │   ├── compare.tsx           # Compare page (/compare)
│   │   ├── auth.callback.tsx     # OAuth callback (/auth/callback)
│   │   ├── -compare/             # Compare page components (private route)
│   │   │   ├── comparator-context.tsx
│   │   │   ├── RepositoryReleasesComparator.tsx
│   │   │   └── [other components]
│   │   └── -home/                # Home page components (private route)
│   ├── components/               # Shared React components
│   ├── hooks/                    # Custom React hooks
│   │   ├── useProcessDescriptionMdast.ts
│   │   └── useProcessReleases.ts
│   ├── queries/                  # TanStack Query hooks
│   │   ├── release.tsx           # GitHub releases API queries
│   │   └── repository.tsx        # GitHub repos API queries
│   ├── mocks/                    # MSW mock setup
│   │   ├── handlers/             # Request handlers
│   │   ├── browser.ts            # Browser MSW setup
│   │   └── server.ts             # Node MSW setup
│   ├── fixtures/                 # Test data and fixtures
│   │   └── github/               # GitHub API response fixtures
│   ├── __tests__/                # Unit tests (Vitest)
│   ├── custom-theme.ts           # Chakra UI theme customization
│   ├── github-auth.ts            # GitHub OAuth logic
│   ├── github-client.ts          # Octokit client configuration
│   ├── utils.ts                  # Utility functions
│   ├── test-utils.tsx            # Testing utilities wrapper
│   ├── router.tsx                # TanStack Router configuration
│   ├── routeTree.gen.ts          # Auto-generated route tree (do not edit)
│   └── vitest.setup.ts           # Vitest global setup
├── e2e/                          # Playwright E2E tests
│   ├── compare.spec.ts
│   ├── auth.spec.ts
│   ├── home.spec.ts
│   ├── not-found.spec.ts
│   └── playwright-utils.ts
├── public/                       # Static assets
│   └── mockServiceWorker.js      # MSW worker script (auto-generated)
├── .github/
│   ├── actions/
│   │   └── setup-project/        # Reusable CI setup action
│   └── workflows/
│       └── verifications.yml     # Main CI workflow
└── [config files]
```

## Routing System (TanStack Router)

### File-Based Routing

Routes are defined by files in `src/routes/`:

- `index.tsx` → `/`
- `compare.tsx` → `/compare`
- `auth.callback.tsx` → `/auth/callback`

### Private Route Segments

Directories starting with `-` are **private route segments** (not part of the URL):

- `src/routes/-compare/` → Components used by `/compare` route
- `src/routes/-home/` → Components used by `/` route

These allow co-locating route-specific components without affecting the URL structure.

### Route Tree Generation

The route tree is auto-generated in `src/routeTree.gen.ts`. Do not edit this file manually - it updates automatically when route files change during development.

### Router Configuration

Main router setup is in `src/router.tsx`, which:

- Creates the router instance
- Configures default preload behavior
- Sets up context providers

## State Management

### Server State

**TanStack Query** manages all server state (GitHub API data):

- Queries defined in `src/queries/`
- Automatic caching, refetching, and background updates
- SSR support via `@tanstack/react-router-ssr-query`

### Client State

**React Context** for local UI state:

- `src/routes/-compare/comparator-context.tsx` - Compare page state

No global state management library is used for client state.

### Authentication State

GitHub OAuth tokens are stored in cookies using `js-cookie`:

- Managed in `src/github-auth.ts`
- Used by Octokit client for authenticated API requests

## Markdown Processing Pipeline

Release notes are processed through a unified pipeline:

1. **Parse**: `remark-parse` converts markdown to MDAST (Markdown AST)
2. **Transform** (remark plugins):
   - `remark-gfm` - Tables, strikethrough, task lists
   - `remark-emoji` - `:emoji:` syntax
   - `remark-github` - Auto-link issues, mentions, commits
3. **Convert**: `remark-rehype` converts MDAST to HAST (HTML AST)
4. **Transform** (rehype plugins):
   - `rehype-highlight` - Syntax highlighting for code blocks
5. **Render**: `rehype-react` renders HAST as React components

The pipeline is encapsulated in `src/hooks/useProcessDescriptionMdast.ts`.

## Release Processing

Releases are processed and normalized in `src/hooks/useProcessReleases.ts`:

- Parse and group changelog entries
- Sort by semantic version
- Filter by version range
- Categorize changes (breaking, features, fixes)

## Key Configuration Files

### TypeScript

**File**: `tsconfig.json`

- Strict mode enabled
- Path aliases: `@/*` → `./src/*`, `@/public/*` → `./public/*`
- React 19 JSX transform
- Target: ES2022

### Vite

**File**: `vite.config.ts`

- TanStack Start plugin
- Netlify adapter for static site generation
- Sentry integration
- Path alias resolution via `vite-tsconfig-paths`

### Prerendering

Routes are prerendered at build time for static deployment:

- Configured in `vite.config.ts`
- Routes defined in `prerender.routes` array

### ESLint

**File**: `eslint.config.js`

- Flat config format (ESLint 9+)
- Multiple plugins (see [CODE_STYLE.md](CODE_STYLE.md))

### Prettier

**File**: `prettier.config.js`

- Single quotes, no semicolons, tabs

### Vitest

**File**: `vitest.config.ts`

- Imports Vite config
- Setup file: `src/vitest.setup.ts`
- Coverage provider: v8

### Playwright

**File**: `playwright.config.ts`

- Test directory: `e2e/`
- Single project: Chromium
- webServer configuration for local dev

## Deployment

### Netlify

The application deploys to Netlify as a static site:

1. Build runs `pnpm build`
2. TanStack Start prerenders configured routes
3. Static files output to `dist/` (distributed via CDN)
4. Fallback to client-side routing for non-prerendered routes

### Environment Variables

Netlify deployment requires:

- `VITE_GITHUB_APP_CLIENT_ID` - GitHub OAuth app client ID
- Sentry configuration (optional, for error tracking)

## Key Integrations

### GitHub API

- **Client**: `src/github-client.ts` (Octokit instance)
- **Auth**: `src/github-auth.ts` (OAuth flow)
- **Queries**: `src/queries/` (TanStack Query wrappers)

### Sentry

- **Client**: Configured in `vite.config.ts`
- **Server instrumentation**: `instrument.server.mjs`
- Error tracking and performance monitoring in production

### MSW (Mock Service Worker)

- **Browser setup**: `src/mocks/browser.ts`
- **Node setup**: `src/mocks/server.ts`
- Enabled via `VITE_API_MOCKING=enabled`
- Mock data in `src/fixtures/github/`
